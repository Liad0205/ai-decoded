---
// Homepage - Developer-focused documentation aesthetic
import BaseLayout from '../layouts/BaseLayout.astro';
import MathBlock from '../components/MathBlock.astro';
import LucideIcon from '../components/LucideIcon.astro';
import Button from '../components/ui/Button.astro';
import { Icon } from '../components/Icon';
import { modules, getTotalLessons } from '../content/modules';

const totalLessons = getTotalLessons();

// Phase grouping for curriculum timeline
const phases = [
  { label: 'Foundations', modules: modules.filter(m => m.number >= 1 && m.number <= 2) },
  { label: 'Training & Tuning', modules: modules.filter(m => m.number >= 3 && m.number <= 4) },
  { label: 'Applications', modules: modules.filter(m => m.number >= 5 && m.number <= 8) },
  { label: 'Specialized', modules: modules.filter(m => m.number >= 9 && m.number <= 12) },
  { label: 'Production', modules: modules.filter(m => m.number === 13) },
];

// Equation panels for animated terminal
const equations = [
  {
    file: 'attention.tex',
    comment: '// scaled dot-product attention',
    description: 'How transformers weigh relevance between tokens',
    formula: '\\text{Attention}(Q,K,V) = \\text{softmax}\\!\\left(\\frac{QK^\\top}{\\sqrt{d_k}}\\right)V',
    module: 'transformers',
    moduleLabel: 'Module 2: The Transformer Architecture',
  },
  {
    file: 'vae-elbo.tex',
    comment: '// evidence lower bound',
    description: 'The optimization target for variational autoencoders',
    formula: '\\log p(x) \\geq \\mathbb{E}_{q(z|x)}\\!\\left[\\log p(x|z)\\right] - D_{\\mathrm{KL}}\\!\\left(q(z|x) \\| p(z)\\right)',
    module: 'diffusion',
    moduleLabel: 'Module 9: Diffusion Models',
  },
  {
    file: 'ppo-clip.tex',
    comment: '// PPO clipped surrogate objective',
    description: 'Constraining policy updates during reinforcement learning',
    formula: 'L^{\\mathrm{CLIP}}(\\theta) = \\hat{\\mathbb{E}}_t\\!\\left[\\min\\!\\left(r_t(\\theta)\\hat{A}_t,\\; \\text{clip}(r_t(\\theta), 1{-}\\epsilon, 1{+}\\epsilon)\\hat{A}_t\\right)\\right]',
    module: 'training-llms',
    moduleLabel: 'Module 3: Training Large Language Models',
  },
  {
    file: 'diffusion.tex',
    comment: '// forward diffusion process',
    description: 'Progressively adding Gaussian noise to training images',
    formula: 'q(x_t | x_{t-1}) = \\mathcal{N}\\!\\left(x_t;\\, \\sqrt{1 - \\beta_t}\\, x_{t-1},\\; \\beta_t \\mathbf{I}\\right)',
    module: 'diffusion',
    moduleLabel: 'Module 9: Diffusion Models',
  },
];
---

<BaseLayout title="AI Decoded - Modern AI, explained for engineers">
  <div class="min-h-screen bg-[hsl(var(--background))]">

    <!-- Hero -->
    <section class="relative overflow-hidden">
      <!-- Dot grid background -->
      <div class="dot-grid absolute inset-0 pointer-events-none"></div>
      <!-- Radial glow -->
      <div class="radial-glow absolute pointer-events-none"></div>

      <div class="relative max-w-6xl mx-auto px-6 pt-24 pb-20 lg:pt-32 lg:pb-24">
        <div class="grid lg:grid-cols-2 gap-12 lg:gap-16 items-center">
          <!-- Left column: text + CTA -->
          <div>
            <p class="font-mono text-sm text-[hsl(var(--muted-foreground))] mb-6">// free and open</p>

            <h1 class="text-4xl lg:text-5xl font-bold tracking-tight text-[hsl(var(--foreground))] mb-6 leading-tight">
              Everything they forgot<br />to teach you about <span class="text-[hsl(var(--primary))]">AI</span>
            </h1>

            <p class="text-lg text-[hsl(var(--muted-foreground))] max-w-2xl mb-8 leading-relaxed">
              {modules.length} modules. Transformers to production. Full math, no hand-waving. Built for software engineers who want to actually understand how this stuff works.
            </p>

            <Button variant="primary" size="lg" href={`${import.meta.env.BASE_URL}${modules[0].slug}/${modules[0].lessons[0].slug}`}>
              Start with Module 1
              <Icon name="ArrowRight" className="w-4 h-4 ml-2" client:load />
            </Button>
          </div>

          <!-- Right column: animated equation terminal -->
          <div class="rounded-lg border border-[hsl(var(--border))] bg-[hsl(var(--card))] overflow-hidden" data-eq-terminal>
            <!-- Title bar -->
            <div class="flex items-center gap-2 px-4 py-2 border-b border-[hsl(var(--border))] bg-[hsl(var(--muted))]">
              <div class="flex gap-1.5">
                <span class="w-2.5 h-2.5 rounded-full bg-red-500/60"></span>
                <span class="w-2.5 h-2.5 rounded-full bg-yellow-500/60"></span>
                <span class="w-2.5 h-2.5 rounded-full bg-green-500/60"></span>
              </div>
              <span class="font-mono text-xs text-[hsl(var(--muted-foreground))]" data-eq-filename>{equations[0].file}</span>
            </div>
            <!-- Equation panels -->
            <div class="px-6 py-6 min-h-[220px] flex flex-col justify-center">
              {equations.map((eq, i) => (
                <div
                  class:list={['eq-panel transition-opacity duration-400', i !== 0 && 'hidden']}
                  data-eq-panel={i}
                  data-eq-file={eq.file}
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span class="w-1 h-4 rounded-full bg-[hsl(var(--primary))]"></span>
                    <p class="font-mono text-xs text-[hsl(var(--primary))]">{eq.comment}</p>
                  </div>
                  <p class="text-xs text-[hsl(var(--muted-foreground))] mb-4 ml-3">{eq.description}</p>
                  <MathBlock formula={eq.formula} display={true} />
                  <a
                    href={`${import.meta.env.BASE_URL}${eq.module}`}
                    class="mt-4 inline-block text-xs font-medium text-[hsl(var(--muted-foreground))] hover:text-[hsl(var(--primary))] transition-colors"
                  >
                    {eq.moduleLabel} &rarr;
                  </a>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- What's inside -->
    <section class="border-t border-[hsl(var(--border))]">
      <div class="max-w-5xl mx-auto px-6 py-20">
        <p class="font-mono text-xs uppercase tracking-widest text-[hsl(var(--muted-foreground))] mb-12">What's inside</p>

        <div class="grid md:grid-cols-3 gap-12">
          <div>
            <p class="font-mono text-sm text-[hsl(var(--primary))] mb-3">01 / derivations</p>
            <h3 class="text-lg font-semibold text-[hsl(var(--foreground))] mb-2">First-principles mathematics</h3>
            <p class="text-sm text-[hsl(var(--muted-foreground))] leading-relaxed">
              No hand-waving. Every architecture derived step by step: the ELBO for diffusion models, PPO's clipped objective, backpropagation through attention. You'll know <em>why</em>, not just <em>what</em>.
            </p>
          </div>

          <div>
            <p class="font-mono text-sm text-[hsl(var(--primary))] mb-3">02 / interactive</p>
            <h3 class="text-lg font-semibold text-[hsl(var(--foreground))] mb-2">Active recall built in</h3>
            <p class="text-sm text-[hsl(var(--muted-foreground))] leading-relaxed">
              Three component types keep you engaged: knowledge-check quizzes after each section, progressive reveals that walk through derivations one step at a time, and animated diagrams that visualize data flow.
            </p>
          </div>

          <div>
            <p class="font-mono text-sm text-[hsl(var(--primary))] mb-3">03 / references</p>
            <h3 class="text-lg font-semibold text-[hsl(var(--foreground))] mb-2">Curated source references</h3>
            <p class="text-sm text-[hsl(var(--muted-foreground))] leading-relaxed">
              Every lesson cites its sources with clickable reference cards linking to the original papers, engineering blogs, and official documentation. Three source types (research papers, blog posts, docs) are tagged and linked so you can go deeper.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Curriculum Timeline -->
    <section id="modules" class="border-t border-[hsl(var(--border))]">
      <div class="max-w-5xl mx-auto px-6 py-20 pb-24">
        <!-- Section header -->
        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between mb-12 gap-4">
          <div>
            <h2 class="text-2xl font-bold text-[hsl(var(--foreground))] mb-2">Curriculum</h2>
            <p class="text-sm text-[hsl(var(--muted-foreground))]">
              {modules.length} modules &middot; {totalLessons} lessons
            </p>
          </div>
          <p class="font-mono text-xs text-[hsl(var(--muted-foreground))]">foundations &rarr; production</p>
        </div>

        <!-- Timeline -->
        <div class="space-y-10">
          {phases.map(phase => (
            <div>
              <!-- Phase label with extending rule -->
              <div class="flex items-center gap-4 mb-6">
                <span class="font-mono text-xs uppercase tracking-widest text-[hsl(var(--primary))] shrink-0">{phase.label}</span>
                <div class="h-px flex-1 bg-[hsl(var(--border))]"></div>
              </div>

              <!-- Module rows with vertical timeline -->
              <div class="border-l-2 border-[hsl(var(--border))] ml-5 space-y-1">
                {phase.modules.map(mod => (
                  <a
                    href={`${import.meta.env.BASE_URL}${mod.slug}`}
                    class="group relative flex items-center gap-4 py-3 px-5 rounded-r-lg hover:bg-[hsl(var(--muted))] transition-colors"
                  >
                    {/* Timeline dot */}
                    <span class="absolute left-[-7px] w-3 h-3 rounded-full bg-[hsl(var(--primary))] border-2 border-[hsl(var(--background))]"></span>

                    {/* Module number */}
                    <span class="font-mono text-xs text-[hsl(var(--muted-foreground))] shrink-0 w-6">
                      {String(mod.number).padStart(2, '0')}
                    </span>

                    {/* Icon */}
                    <span class="shrink-0 text-[hsl(var(--muted-foreground))] group-hover:text-[hsl(var(--primary))] transition-colors">
                      <LucideIcon name={mod.icon} size={18} />
                    </span>

                    {/* Title + lesson count */}
                    <span class="text-sm font-medium text-[hsl(var(--foreground))] group-hover:text-[hsl(var(--primary))] transition-colors shrink-0">
                      {mod.title}
                    </span>
                    <span class="text-xs text-[hsl(var(--muted-foreground))] shrink-0">
                      {mod.lessons.length} {mod.lessons.length === 1 ? 'lesson' : 'lessons'}
                    </span>

                    {/* Description -- hidden on mobile */}
                    <span class="hidden sm:inline text-xs text-[hsl(var(--muted-foreground))] truncate">
                      / {mod.description}
                    </span>
                  </a>
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="border-t border-[hsl(var(--border))]">
      <div class="max-w-5xl mx-auto px-6 py-16 pb-20 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
        <div>
          <h2 class="text-xl font-semibold text-[hsl(var(--foreground))] mb-1">Ready to start?</h2>
          <p class="text-sm text-[hsl(var(--muted-foreground))]">Begin with the mathematical foundations and work up to production systems.</p>
        </div>
        <Button variant="primary" size="md" href={`${import.meta.env.BASE_URL}${modules[0].slug}/${modules[0].lessons[0].slug}`}>
          Begin Module 1
          <Icon name="ArrowRight" className="w-4 h-4 ml-2" client:load />
        </Button>
      </div>
    </section>

  </div>
</BaseLayout>

<script>
  // Equation terminal cycling animation
  const terminal = document.querySelector('[data-eq-terminal]');
  if (terminal) {
    const panels = terminal.querySelectorAll<HTMLElement>('[data-eq-panel]');
    const filenameEl = terminal.querySelector<HTMLElement>('[data-eq-filename]');
    let current = 0;

    setInterval(() => {
      const currentPanel = panels[current];
      // Fade out
      currentPanel.style.opacity = '0';

      setTimeout(() => {
        // Hide current, show next
        currentPanel.classList.add('hidden');
        current = (current + 1) % panels.length;
        const nextPanel = panels[current];
        nextPanel.classList.remove('hidden');

        // Update filename
        if (filenameEl) {
          filenameEl.textContent = nextPanel.getAttribute('data-eq-file') || '';
        }

        // Fade in (request next frame so the browser registers the hiddenâ†’visible change)
        requestAnimationFrame(() => {
          nextPanel.style.opacity = '1';
        });
      }, 400);
    }, 4000);
  }
</script>

<style>
  .eq-panel {
    transition: opacity 400ms ease;
  }

  .dot-grid {
    background-image: radial-gradient(circle, hsl(var(--muted-foreground) / 0.3) 1px, transparent 1px);
    background-size: 24px 24px;
  }
  :global(.dark) .dot-grid {
    background-image: radial-gradient(circle, hsl(var(--muted-foreground) / 0.15) 1px, transparent 1px);
  }

  .radial-glow {
    width: 600px;
    height: 600px;
    top: 50%;
    left: 25%;
    transform: translate(-50%, -50%);
    background: radial-gradient(circle, hsl(var(--primary) / 0.12) 0%, transparent 70%);
  }
  :global(.dark) .radial-glow {
    background: radial-gradient(circle, hsl(var(--primary) / 0.08) 0%, transparent 70%);
  }
</style>
